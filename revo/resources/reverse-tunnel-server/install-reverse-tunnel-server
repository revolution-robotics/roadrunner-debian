#!/usr/bin/env bash
#
# @(#) install-node-lts
#
# This script installs node version manager and then the latest node
# version of the $node_base series.
#

# Edit these ...
: ${NODE_BASE:='@NODE_BASE@'}
: ${NODE_GROUP:='@NODE_GROUP@'}
: ${NODE_USER:='@NODE_USER@'}

# Command paths
: ${AWK:='/usr/bin/awk'}
: ${BASH:='/bin/bash'}
: ${CAT:='/bin/cat'}
: ${CURL:='/usr/bin/curl'}
: ${GETENT:='/usr/bin/getent'}
: ${GIT:='/usr/bin/git'}
: ${GREP:='/bin/grep'}
: ${GROUPADD:='/usr/sbin/groupadd'}
: ${SED:='/bin/sed'}
: ${SORT:='/usr/bin/sort'}
: ${SUDO:='/usr/bin/sudo'}
: ${TAIL:='/usr/bin/tail'}
: ${USERADD:='/usr/sbin/useradd'}

declare -r homedir=$($GETENT passwd "$NODE_USER" | $AWK -F: '{ print $6 }')

clone_or_update_asdf_repo ()
{
    echo "Cloning..."
    $CAT <<EOF | $SUDO  -u "$NODE_USER" $BASH -s
if test -d ~/.asdf; then
    git -C ~/.asdf pull
else
    git clone https://github.com/asdf-vm/asdf.git ~/.asdf
fi
EOF
    echo "Done cloning..."
}

init_asdf_in_bashrc ()
{
    echo "Appending to bashrc..."
    $CAT >>"${homedir}/.bashrc" <<'EOF'

# Initialize asdf version manager.
export ASDF_DIR=~/.asdf
if test -f "${ASDF_DIR}/asdf.sh"; then
    source "${ASDF_DIR}/asdf.sh"
    source "${ASDF_DIR}/completions/asdf.bash"
fi
EOF
}

install_node ()
{
    echo "Installing node..."
    $CAT <<EOF | $SUDO -i -u "$NODE_USER" $BASH -s
export ASDF_DIR=~/.asdf
if test -f "\${ASDF_DIR}/asdf.sh"; then
    . "\${ASDF_DIR}/asdf.sh"
    if type asdf >/dev/null 2>&1; then
        asdf plugin add nodejs || true
        node_lts=\$(asdf latest nodejs "$NODE_BASE")
        asdf install nodejs "\$node_lts"
        asdf global  nodejs "\$node_lts"
        \${ASDF_DIR}/shims/npm i -g npm
        asdf reshim nodejs
    fi
fi
EOF
}

install_remote_access_server ()
{
    if test -f "${homedir}/reverse-tunnel-server"*.tgz; then
        $SUDO mkdir ~/.ssh
        $CAT <<EOF | $SUDO -i -u "$NODE_USER" $BASH -s
export ASDF_DIR=~/.asdf
if test -f "\${ASDF_DIR}/asdf.sh"; then
    . "\${ASDF_DIR}/asdf.sh"
    \${ASDF_DIR}/shims/npm i -g "${homedir}/reverse-tunnel-server"*.tgz
    asdf reshim nodejs
    srcdir=\$(npm prefix -g)/lib/node_modules/reverse-tunnel-server
    $SUDO install -m 0644 "\${srcdir}/config/reverse-tunnel"  /etc/default
    $SUDO install -m 0644 "\${srcdir}/scripts/reverse-tunnel@.service"  /lib/systemd/system/
    mkdir -p ~/.ssh
    statedir=\$(awk  '/^API_STATE_DIR/ { print \$NF }' /etc/default/reverse-tunnel)
    $SUDO mkdir -p "\${statedir}"/{certs,config,secrets}
    $SUDO chown -R ${NODE_USER}:${NODE_GROUP} "\${statedir}"
    $SUDO chmod 700 "\${statedir}/secrets"
fi
EOF
    fi
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    clone_or_update_asdf_repo
    init_asdf_in_bashrc
    install_node
    install_remote_access_server
fi
