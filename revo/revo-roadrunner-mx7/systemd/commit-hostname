#!/usr/bin/env bash
#
# @(#) commit-hostname
#
# Copyright Â© 2021,2024 Revolution Robotics, Inc.
#
# This script generates and sets a unique hostname. It is intended to
# be run by hostname-commit.service. The following files are affected:
#
#     /etc/hostname
#     /etc/hosts
#     /etc/mailname
#
# Following the hostname update, SSH host keys and TLS certificates
# are regenerated as well.
#
# See also `update-hostname' for updating a live system.
#
# NB: A hostname is generated from the MAC of the first enumerated
#     physical interface, which is identified by its queuing
#     disciple (mq). But queueing disciples must be loaded, so upon
#     systemd reaching network.target, a brief delay must be added
#     before running this script.
#
: ${AWK_CMD:='/usr/bin/awk'}
: ${CUT_CMD:='/usr/bin/cut'}
: ${GREP_CMD:='/bin/grep'}
: ${HOSTNAMECTL_CMD:='/usr/bin/hostnamectl'}
: ${IP_CMD:='/bin/ip'}
: ${OPENSSL_CMD:='/usr/bin/openssl'}
: ${RM_CMD:='/bin/rm'}
: ${SED_CMD:='/bin/sed'}
: ${SSH_KEYGEN_CMD:='/usr/bin/ssh-keygen'}
: ${TLS_GENERATE_SELF_SIGNED_CMD:='/usr/sbin/tls-generate-self-signed'}

get-mac-digest ()
{
    $IP_CMD -o -br link show |
        $GREP_CMD -E '^(e|w)' |
        $AWK_CMD '{ print $3; exit }' |
        $OPENSSL_CMD dgst -r -sha256 |
        $CUT_CMD -c1-6
}

update-hostnames ()
{
    local hn=$1

    $HOSTNAMECTL_CMD  --static --transient --pretty set-hostname "$hn"
}

update-hosts ()
{
    local hn=$1

    if $GREP_CMD -q '^127.0.1.1' /etc/hosts; then
        $SED_CMD -i -E -e 's;^(127.0.0.1).*;\1\tlocalhost;' \
             -e "s;^(127.0.1.1).*;\1\t$hn;" /etc/hosts
    else
        $SED_CMD -i -E -e 's;^(127.0.0.1).*;\1\tlocalhost;' \
             -e "/^127.0.0.1/a 127.0.1.1\t$hn" /etc/hosts
    fi
}

update-mailname ()
{
    local hn=$1

    echo "$hn" >/etc/mailname
}

ssh-generate-keys ()
{
    $RM_CMD -f /etc/ssh/ssh_host_*_key*
    $SSH_KEYGEN_CMD -A
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    declare hn=revoedge-$(get-mac-digest)

    update-hostnames "$hn"
    update-hosts "$hn"
    update-mailname "$hn"

    # NB: Certificates must be regenerated last!
    ssh-generate-keys
    $TLS_GENERATE_SELF_SIGNED_CMD
fi
